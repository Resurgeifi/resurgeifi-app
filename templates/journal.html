{% extends "base.html" %}
{% block title %}Journal | Resurgifi{% endblock %}

{% block content %}
<!-- 🪨 Cracked Stone Title Image -->
<img src="{{ url_for('static', filename='titles/journal.png') }}" 
     alt="Journal Title" 
     style="display: block; max-width: 250px; margin: 2rem auto;" />

<div class="main-content">

  <!-- 🔄 Current Ring Status -->
  <div class="ring-status">
    <p style="font-size: 1.1rem; color: #e0d4b2;">
      🔄 Current Ring: <strong>{{ current_ring }}</strong>
    </p>
  </div>

  <!-- ⚡ Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-container">
        {% for category, message in messages %}
          <div class="flash flash-{{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- 📝 Journal Form -->
  <form id="journalForm" method="POST" action="/journal" style="margin-top: 1.5rem;">
    <label for="entry" style="font-size: 1.2rem;"><strong>What’s on your mind today?</strong></label><br><br>
    <textarea 
      name="entry" 
      rows="6" 
      placeholder="Just write what you feel. What did or do I want to accomplish today?"
      style="width: 100%; padding: 1rem; font-size: 1rem; border-radius: 10px; border: 2px solid #1e2d2b; background: #f6e7c1; color: #1f3e36;"
    >{{ summary_text or "" }}</textarea><br><br>
    <button type="submit" class="global-button">Save Entry</button>
  </form>

  <hr class="section-divider" style="margin: 2.5rem 0; border: 1px solid #444;">

  <!-- 📜 Previous Journal Entries -->
  {% if entries %}
    <h2 style="text-align: center; color: #f6e7c1;">Previous Entries</h2>
    {% for entry in entries %}
      <div class="entry-box">
        <div class="timestamp">
          {{ entry.timestamp }}
          <span style="margin-left: 10px;">🧠</span>
        </div>
        <div style="margin-top: 0.5rem;">{{ entry.content }}</div>
        <div style="margin-top: 10px; display: flex; justify-content: flex-end; gap: 12px;">
          <!-- ✏️ Edit -->
          <form method="GET" action="{{ url_for('edit_entry', id=entry.id) }}" style="display: inline;">
            <button type="submit" class="global-button" style="padding: 8px 16px; font-size: 0.9rem;">Edit</button>
          </form>

          <!-- 🗑️ Delete -->
          <form method="POST" action="/delete-entry/{{ entry.id }}" class="delete-form" style="display: inline;">
            <button type="submit" class="global-button" style="background-color: #e11d48; padding: 8px 16px; font-size: 0.9rem;">Delete</button>
          </form>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p style="color: #f6e7c1;">No entries yet. Your story starts now.</p>
  {% endif %}
</div>

<!-- 🌟 Cognita Flash -->
<div id="cognitaFlash" class="hero-flash" style="display: none;">
  <img src="{{ url_for('static', filename='images/heroes/cognita/cognita_writing.png') }}"
       class="lucentis-image floaty" alt="Cognita Writing" />
  <p class="hero-quote">“Every time you reflect, you rewire. You just grew.”</p>
</div>

<!-- 🚩 Warden Fall Flash -->
<div id="wardenFlash" class="hero-flash" style="display: none;">
  <img src="{{ url_for('static', filename='images/villains/wardenfall/wardenfall_flash.png') }}"
       class="lucentis-image floaty" alt="Warden Fall" />
  <p id="wardenQuote" class="scroll-quote">“Some sins echo forever…”</p>
</div>

<!-- 🔊 AUDIO -->
<audio id="flashSound" preload="auto" playsinline src="{{ url_for('static', filename='audio/cognita_flash.mp3') }}"></audio>
<audio id="wardenSound" preload="auto" playsinline src="{{ url_for('static', filename='audio/wardenfall_flash.mp3') }}"></audio>

<!-- 🧠 Flash Logic -->
<script>
  function bindJournalFlash() {
    const journalForm = document.getElementById("journalForm");
    const cognitaFlash = document.getElementById("cognitaFlash");
    const cognitaAudio = document.getElementById("flashSound");

    if (journalForm && cognitaFlash && cognitaAudio) {
      journalForm.addEventListener("submit", function (e) {
        e.preventDefault();
        cognitaFlash.style.display = "flex";
        cognitaFlash.style.opacity = 1;
        cognitaAudio.pause();
        cognitaAudio.currentTime = 0;
        cognitaAudio.volume = 1.0;
        cognitaAudio.play().catch(() => {});
        setTimeout(() => {
          const fade = setInterval(() => {
            if (cognitaAudio.volume > 0.1) {
              cognitaAudio.volume -= 0.1;
            } else {
              cognitaAudio.volume = 0;
              cognitaAudio.pause();
              clearInterval(fade);
            }
          }, 100);
        }, 3000);
        setTimeout(() => {
          cognitaFlash.style.opacity = 0;
          cognitaFlash.style.display = "none";
          journalForm.submit();
        }, 5000);
      });
    }
  }

  function bindDeleteFlash() {
    const deleteForms = document.querySelectorAll(".delete-form");
    const wardenFlash = document.getElementById("wardenFlash");
    const wardenQuote = document.getElementById("wardenQuote");
    const wardenAudio = document.getElementById("wardenSound");

    deleteForms.forEach(form => {
      form.addEventListener("submit", function (e) {
        e.preventDefault();
        wardenQuote.classList.remove("scroll-quote");
        void wardenQuote.offsetWidth;
        wardenQuote.classList.add("scroll-quote");
        wardenFlash.classList.remove("fade-out");
        wardenFlash.style.display = "flex";
        wardenFlash.style.opacity = 1;
        if (wardenAudio) {
          wardenAudio.pause();
          wardenAudio.currentTime = 0;
          wardenAudio.volume = 1.0;
          wardenAudio.play().catch(() => {});
          setTimeout(() => {
            const fade = setInterval(() => {
              if (wardenAudio.volume > 0.1) {
                wardenAudio.volume -= 0.1;
              } else {
                wardenAudio.volume = 0;
                wardenAudio.pause();
                clearInterval(fade);
              }
            }, 100);
          }, 3000);
        }
        setTimeout(() => {
          wardenFlash.classList.add("fade-out");
        }, 4200);
        setTimeout(() => {
          wardenFlash.style.display = "none";
          form.submit();
        }, 5500);
      });
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    bindJournalFlash();
    bindDeleteFlash();
  });
</script>
{% endblock %}


