{% extends "base.html" %}
{% block title %}Journal | Resurgifi{% endblock %}

{% block content %}
<img src="{{ url_for('static', filename='titles/journal.png') }}" 
     alt="Journal Title" 
     style="display: block; max-width: 250px; margin: 2rem auto;" />

<div class="main-content">

  <div class="ring-status">
    <p style="font-size: 1.1rem; color: #e0d4b2;">
      üîÑ Current Ring: <strong>{{ current_ring }}</strong>
    </p>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-container">
        {% for category, message in messages %}
          <div class="flash flash-{{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <form id="journalForm" method="POST" action="/journal" style="margin-top: 1.5rem;">
    <label for="entry" style="font-size: 1.2rem;"><strong>What‚Äôs on your mind today?</strong></label><br><br>
    <textarea 
      name="entry" 
      rows="6" 
      placeholder="Just write what you feel. What did or do I want to accomplish today?"
      style="width: 100%; padding: 1rem; font-size: 1rem; border-radius: 10px; border: 2px solid #1e2d2b; background: #f6e7c1; color: #1f3e36;"
    >{{ summary_text or "" }}</textarea><br><br>
    <button type="submit" class="global-button">Save Entry</button>
  </form>

  <hr class="section-divider" style="margin: 2.5rem 0; border: 1px solid #444;">

  {% if entries %}
    <h2 style="text-align: center; color: #f6e7c1;">Previous Entries</h2>
    {% for entry in entries %}
      <div class="entry-box">
        <div class="timestamp">
          {{ entry.timestamp }}
          <span style="margin-left: 10px;">üß†</span>
        </div>
        <div style="margin-top: 0.5rem;">{{ entry.content }}</div>
        <div class="entry-buttons">
          <form method="GET" action="{{ url_for('edit_entry', id=entry.id) }}">
            <button type="submit" class="entry-button edit">Edit</button>
          </form>
          <form method="POST" action="/delete-entry/{{ entry.id }}" class="delete-form">
            <button type="submit" class="entry-button delete">Delete</button>
          </form>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p style="color: #f6e7c1;">No entries yet. Your story starts now.</p>
  {% endif %}
</div>

<!-- üåü Cognita Flash -->
<div id="cognitaFlash" class="hero-flash">
  <img src="{{ url_for('static', filename='images/heroes/cognita/cognita_writing.png') }}" alt="Cognita Writing" />
  <div class="speech-box">
    <p class="hero-quote">‚ÄúEvery time you reflect, you rewire. You just grew.‚Äù</p>
  </div>
</div>

<!-- üö© Warden Fall Flash -->
<div id="wardenFlash" class="hero-flash">
  <img src="{{ url_for('static', filename='images/villains/wardenfall/wardenfall_flash.png') }}" alt="Warden Fall" />
  <div class="speech-box">
    <p class="hero-quote scroll-quote">‚ÄúSome sins echo forever‚Ä¶‚Äù</p>
  </div>
</div>

<!-- üîä AUDIO -->
<audio id="flashSound" preload="auto" playsinline src="{{ url_for('static', filename='audio/cognita_flash.mp3') }}"></audio>
<audio id="wardenSound" preload="auto" playsinline src="{{ url_for('static', filename='audio/wardenfall_flash.mp3') }}"></audio>

<style>
.hero-flash {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 9999;
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0.75);
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.4s ease;
}
.hero-flash img {
  width: 80vw;
  max-width: 400px;
  height: auto;
  object-fit: contain;
  animation: pulseGlow 3s ease-out;
}
.speech-box {
  background: #000;
  margin-top: 1.5rem;
  padding: 1.4rem 1.8rem;
  border-radius: 14px;
  max-width: 90vw;
  text-align: center;
  box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
}
.hero-quote {
  font-size: 1.5rem;
  font-weight: bold;
  color: #f6e7c1;
  line-height: 1.6;
}
.scroll-quote {
  animation: scrollUpFade 4s ease-out;
}
.fade-out {
  animation: fadeOutSmooth 1s ease-out;
}
.entry-buttons {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  margin-top: 10px;
}
.entry-button {
  padding: 10px 20px;
  font-size: 0.95rem;
  font-weight: bold;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
  transition: background-color 0.2s ease;
  min-width: 100px;
}
.entry-button.edit {
  background-color: #f4a259;
  color: #1f3e36;
  border: 2px solid #1f3e36;
}
.entry-button.edit:hover {
  background-color: #f69e3e;
}
.entry-button.delete {
  background-color: #e11d48;
  color: #fff;
  border: 2px solid #590b26;
}
.entry-button.delete:hover {
  background-color: #c8103f;
}
</style>

<script>
function bindJournalFlash() {
  const journalForm = document.getElementById("journalForm");
  const cognitaFlash = document.getElementById("cognitaFlash");
  const cognitaAudio = document.getElementById("flashSound");

  if (journalForm && cognitaFlash && cognitaAudio) {
    journalForm.addEventListener("submit", function (e) {
      e.preventDefault();
      cognitaFlash.style.display = "flex";
      cognitaFlash.style.opacity = 1;
      cognitaAudio.pause();
      cognitaAudio.currentTime = 0;
      cognitaAudio.volume = 1.0;
      cognitaAudio.play().catch(() => {});
      setTimeout(() => {
        const fade = setInterval(() => {
          if (cognitaAudio.volume > 0.05) {
            cognitaAudio.volume -= 0.1;
          } else {
            cognitaAudio.volume = 0;
            cognitaAudio.pause();
            clearInterval(fade);
          }
        }, 100);
      }, 3000);
      setTimeout(() => {
        cognitaFlash.style.opacity = 0;
        cognitaFlash.style.display = "none";
        journalForm.submit();
      }, 5000);
    });
  }
}

function bindDeleteFlash() {
  const deleteForms = document.querySelectorAll(".delete-form");
  const wardenFlash = document.getElementById("wardenFlash");
  const wardenAudio = document.getElementById("wardenSound");

  deleteForms.forEach(form => {
    form.addEventListener("submit", function (e) {
      e.preventDefault();
      wardenFlash.style.display = "flex";
      wardenFlash.style.opacity = 1;
      if (wardenAudio) {
        wardenAudio.pause();
        wardenAudio.currentTime = 0;
        wardenAudio.volume = 1.0;
        wardenAudio.play().catch(() => {});
        setTimeout(() => {
          const fade = setInterval(() => {
            if (wardenAudio.volume > 0.05) {
              wardenAudio.volume -= 0.1;
            } else {
              wardenAudio.volume = 0;
              wardenAudio.pause();
              clearInterval(fade);
            }
          }, 100);
        }, 3000);
      }
      setTimeout(() => {
        wardenFlash.style.opacity = 0;
        wardenFlash.style.display = "none";
        form.submit();
      }, 5000);
    });
  });
}

document.addEventListener('DOMContentLoaded', () => {
  bindJournalFlash();
  bindDeleteFlash();
});
</script>
{% endblock %}








